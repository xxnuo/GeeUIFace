# GeeUIFace表情播放逻辑分析

## 基础表情播放机制

### 表情初始化
- 应用启动时，从Intent中获取初始表情名称，默认为"h0059"
- 表情视频存储在assets/video/目录下，格式为MP4
- 表情通过文件名进行标识，如"h0059.mp4"

### 播放器实现
- 使用IjkMediaPlayer作为视频播放器
- 表情视频在SurfaceView(binding.playerView)上展示
- 设置了硬件解码选项提高性能：
  ```kotlin
  it.setOption(IjkMediaPlayer.OPT_CATEGORY_PLAYER, "mediacodec", 1) //视频硬件解码
  it.setOption(IjkMediaPlayer.OPT_CATEGORY_PLAYER, "opensles", 1) //音频硬件解码
  it.setOption(IjkMediaPlayer.OPT_CATEGORY_PLAYER, "framedrop", 1) //设置跳帧
  ```

### 表情播放流程
1. 通过`openVideo(faceName)`方法切换表情
2. 释放旧的播放器实例，创建新的播放器
3. 从assets目录加载对应名称的MP4文件
4. 设置监听器处理播放状态
5. 视频加载完成后自动开始播放
6. 视频播放完成后自动重新播放(循环播放)

### 表情切换触发方式
- 通过Intent传递新的表情名称
- 通过AutoService服务的`changeFace(faceName)`回调方法
- 通过AIDL接口从其他组件接收表情切换命令

## 表情与语音协同机制

### 语音播放时的表情状态
- 系统定义了专门的表情用于语音播放：
  - 普通说话表情："h0292"
  - AI说话表情："h0346"
  - AI听取表情：根据模型不同有"h0184"、"h0185"、"h0233"

### 语音表情触发流程
- 在`GestureCenter.java`中定义了专门的方法：
  ```java
  public static ArrayList<GestureData> getSpeakingGesture() {
      ArrayList<GestureData> list = new ArrayList<>();
      GestureData gestureData = new GestureData();
      gestureData.setExpression(new Face("h0292"));
      list.add(gestureData);
      return list;
  }

  public static ArrayList<GestureData> getSpeakingWithAIGesture() {
      ArrayList<GestureData> list = new ArrayList<>();
      GestureData gestureData = new GestureData();
      gestureData.setExpression(new Face("h0346"));
      gestureData.setFootAction(new Motion(getRandomMotion(new int[]{25, 26, 28, 55, 56})));
      gestureData.setAntennalight(getRandomAntennaLight());
      if (getRandomIndex(10) % 6 == 0) {
          gestureData.setEarAction(getRandomAntennaMotion());
      }
      gestureData.setInterval(1000);
      list.add(gestureData);
      return list;
  }
  ```

### 表情与语音同步处理
- `AutoService.kt`中的`responseGestureData()`方法负责协调表情和语音：
  ```kotlin
  private fun responseGestureData(
      gestureData: GestureData?, iLetianpaiService: ILetianpaiService?
  ) {
      if (gestureData == null) {
          return
      }
      try {
          if (gestureData.ttsInfo != null) {
              iLetianpaiService?.setTTS("speakText", gestureData.ttsInfo.tts)
          }
          if (gestureData.expression != null) {
              if (faceChangeListener != null) {
                  faceChangeListener!!.changeFace(gestureData.expression.face)
              }
          }
          if (gestureData.soundEffects != null) {
              iLetianpaiService?.setAudioEffect(
                  RobotRemoteConsts.COMMAND_TYPE_SOUND, gestureData.soundEffects.sound
              )
          }
          // 其他动作设置...
      } catch (e: Exception) {
          e.printStackTrace()
      }
  }
  ```

### 特殊模式 - 音频视频同步模式
- 代码中有一个`playAudioAndVideo`标志
- 当此标志为`true`时，会从一组特定的表情中随机选择：
  ```kotlin
  if (playAudioAndVideo) {
      name = getRandomString(arrayOf("h0064", "h0065", "h0066", "h0067", "h0068", "h0069", "h0070", "h0071", "h0072", "h0073", "h0074", "h0075"))
  }
  ```
- 这些表情按时间段分类，对应一天中的不同时段

## 表情分类与管理

### 表情分类
根据`video_expression_mapping.json`，表情被分为多个类别：
- 基础表情组
- 姿态表情（默认姿态、待机、找人等）
- 动作表情（前进、左右动作、摇摆等）
- 时间表情（按一天中不同时段分类）
- 手势表情（OK、点赞、拳头等）
- 特殊表情（第一次进入、睡眠模式等）
- 情绪表情（正向、负向情绪）
- AI交互表情（唤醒、理解、说话等）

### 表情切换逻辑
- 在`AutoService.kt`中实现了一套状态机，控制表情的自动切换
- 通过`showGestures()`方法执行表情切换
- 表情切换可能伴随其他动作（如肢体动作、声音效果）
- 系统会根据不同场景（如找人、待机、交互等）选择不同的表情组

### 表情与动作的组合
表情通常与其他元素组合成`GestureData`对象：
```kotlin
val gestureData = GestureData()
gestureData.expression = Face("h0292") // 表情
gestureData.footAction = Motion(25) // 肢体动作
gestureData.soundEffects = Sound("a0051") // 声音效果
gestureData.antennalight = AntennaLight("on", 5) // 天线灯光
gestureData.earAction = AntennaMotion(2) // 耳朵动作
gestureData.interval = 1000 // 持续时间
```

## 特殊功能实现

### 人脸识别与表情响应
- 系统可以通过`openFaceIdent()`方法启动人脸识别
- 识别结果会触发特定的表情响应
- 通过`searchPeopleResult()`方法处理识别结果

### 自我介绍模式
- 通过`startSelfntroduction()`方法触发自我介绍
- 使用特定的表情序列展示自我介绍内容

### 睡眠模式
- 系统有睡眠模式相关的表情（"h0039"）
- 长时间无交互会进入睡眠模式
- 睡眠模式下会释放电机力量，并显示睡眠表情

## 资源管理

### 表情资源存储
- 表情视频存储在assets/video/目录
- 可能通过ContentProvider查询表情资源
- 部分代码显示可能也支持从SD卡加载表情

### 表情与声音映射
- 表情和声音有对应关系，存储在配置文件中
- 声音文件似乎使用"a"前缀命名（如"a0051"）
- 表情文件使用"h"前缀命名（如"h0059"）

## 生命周期管理

### 应用生命周期处理
- 应用暂停时停止播放表情
- 应用停止时释放播放器资源
- 应用恢复时恢复表情播放
- 在Surface不可用时不会播放视频 